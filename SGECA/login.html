<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connexion - SGECA</title>
  <link rel="stylesheet" href="styleslogin.css" />
</head>

<body>
  <div class="login-container">
    <form class="login-card" id="login-form">
      <div class="avatar"></div>
      <input type="email" id="email" placeholder="Email ID" required />
      <input type="password" id="password" placeholder="Password" required />
      <div class="options">
        <label><input type="checkbox" id="rememberMe" /> Se souvenir de moi</label>
        <a href="#" id="forgot-password">Mot de passe oubli√© ?</a>
      </div>
      <button type="submit" id="login-btn">Connexion</button>
    </form>
  </div>

  <script>
     // üåê URL de base de l'API backend
    const API_BASE_URL = "https://application-web-de-gestion-de-courrier.onrender.com";


    // üîπ Mapping des r√¥les vers les pages
    const rolePages = {
      admin: "DashboardAdministrateur.html",
      agent: "DASHBOARD.html",
      "directeur de cabinet": "DASHBOARD_HIERARCHIE_PRINCIPALE.html",
      "directeur de cabinet adjoint": "DASHBOARD_HIERARCHIE_PRINCIPALE.html",
      IGSJP: "DASHBOARD_SOUS_HIERARCHIE.html",
      "chef de cabinet": "DASHBOARD_HIERARCHIE_PRINCIPALE.html",
      "conseiller technique": "DASHBOARD_SOUS_HIERARCHIE.html",
      "chef de secretariat particulier": "DASHBOARD_SOUS_HIERARCHIE.html",
      "charg√© d'etude": "DASHBOARD_SOUS_HIERARCHIE.html",
      "les directeurs": "DADASHBOARD_SOUS_HIERARCHIE.html"
    };

    // üîπ V√©rifie si l'utilisateur est d√©j√† connect√©
    window.addEventListener('load', async () => {
      try {
        const response = await fetch(`${API_BASE_URL}/api/auth/verify`, {
          method: "GET",
          credentials: 'include'
        });
        if (response.ok) {
          const data = await response.json();
          const role = data.user?.role;
          redirigerSelonRole(role);
        }
      } catch (err) {
        console.log("Utilisateur non connect√©");
      }
    });

    // üîπ Soumission du formulaire
    document.getElementById("login-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const rememberMe = document.getElementById("rememberMe").checked;
      const loginBtn = document.getElementById("login-btn");

      if (!email || !password) {
        alert("Veuillez remplir tous les champs.");
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = "Connexion...";

      try {
        const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: 'include',
          body: JSON.stringify({ email, password, rememberMe }),
        });

        const data = await response.json();

        if (response.ok && data.success) {
          // üîπ Stockage des informations utilisateur
          localStorage.setItem("token", data.token);
          localStorage.setItem("userId", data.user.id);
          localStorage.setItem("role", data.user.role);

          console.log(`[INFO LOGIN FRONT] ${email} connect√© avec r√¥le ${data.user.role}`);

          // üîπ Redirection selon r√¥le
          redirigerSelonRole(data.user.role);

        } else {
          alert(data.message || "Identifiants invalides.");
        }
      } catch (err) {
        console.error("Erreur r√©seau :", err);
        alert("Erreur r√©seau. Veuillez v√©rifier votre connexion.");
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = "Connexion";
      }
    });

    // üîπ Mot de passe oubli√©
    document.getElementById("forgot-password").addEventListener("click", async (e) => {
      e.preventDefault();
      const email = prompt("Entrez votre email pour r√©initialiser le mot de passe :");
      if (email) {
        try {
          const response = await fetch(`${API_BASE_URL}/api/auth/forgot-password`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
          });

          const data = await response.json();

          if (response.ok) {
            alert(data.message || "Email de r√©initialisation envoy√©.");
          } else {
            alert(data.message || "Erreur lors de l'envoi de l'email.");
            console.error("Erreur forgot-password :", data);
          }

        } catch (err) {
          console.error("Erreur r√©seau forgot-password :", err);
          alert("Erreur r√©seau lors de l'envoi de l'email.");
        }
      }
    });


    // üîπ Fonction de redirection selon le r√¥le
    function redirigerSelonRole(role) {
      if (rolePages[role]) {
        window.location.href = rolePages[role];
      } else {
        alert("R√¥le inconnu. Acc√®s refus√©.");
        console.error(`[ERREUR FRONT] R√¥le inconnu : ${role}`);
      }
    }
  </script>
</body>

</html>